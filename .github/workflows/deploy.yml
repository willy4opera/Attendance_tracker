name: Production Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deployment_type:
        description: 'Select deployment type'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - migrations_only
          - frontend_only
          - backend_only

env:
  DEPLOY_PATH: /var/www/html/Attendance_tracker
  REPO_URL: ${{ github.server_url }}/${{ github.repository }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add SSH known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 77.37.121.27 >> ~/.ssh/known_hosts

      - name: Setup Project Directory
        run: |
          echo "âœ¨ Setting up project directory..."
          echo "ğŸ“‹ Repository: ${{ env.REPO_URL }}"
          echo "ğŸ“ Deploy Path: ${{ env.DEPLOY_PATH }}"
          
          ssh root@77.37.121.27 "
            if [ ! -d '${{ env.DEPLOY_PATH }}' ]; then
              echo 'ğŸ†• First-time setup: Creating directory and cloning repository'
              mkdir -p '${{ env.DEPLOY_PATH }}'
              cd /var/www/html
              git clone '${{ env.REPO_URL }}.git' Attendance_tracker
              cd '${{ env.DEPLOY_PATH }}'
              
              echo 'ğŸ“ Setting up directory permissions...'
              chown -R root:root '${{ env.DEPLOY_PATH }}'
              chmod -R 755 '${{ env.DEPLOY_PATH }}'
              
              echo 'âœ… Repository cloned successfully'
            else
              echo 'ğŸ“ Directory exists, checking git configuration...'
              cd '${{ env.DEPLOY_PATH }}'
              
              # Verify and fix git remote if needed
              CURRENT_REMOTE=\$(git config --get remote.origin.url 2>/dev/null || echo 'none')
              EXPECTED_REMOTE='${{ env.REPO_URL }}.git'
              
              if [ \"\$CURRENT_REMOTE\" != \"\$EXPECTED_REMOTE\" ]; then
                echo 'ğŸ”§ Updating git remote URL...'
                git remote set-url origin \"\$EXPECTED_REMOTE\" 2>/dev/null || git remote add origin \"\$EXPECTED_REMOTE\"
                echo \"âœ… Remote updated: \$EXPECTED_REMOTE\"
              else
                echo 'âœ… Git remote is correctly configured'
              fi
            fi
          "

      - name: Deploy Code
        if: github.event.inputs.deployment_type == 'full' || github.event.inputs.deployment_type == 'frontend_only' || github.event.inputs.deployment_type == 'backend_only' || github.event_name == 'push'
        run: |
          echo "ğŸ”„ Deploying latest changes..."
          echo "ğŸ¯ Branch: ${{ github.ref_name }}"
          echo "ğŸ“‹ Commit: ${{ github.sha }}"
          
          ssh root@77.37.121.27 "
            cd '${{ env.DEPLOY_PATH }}' && 
            echo 'ğŸ” Current git status:' && 
            git status --porcelain || true &&
            echo 'ğŸ’¾ Stashing any local changes...' &&
            git stash push -m 'Auto-stash before deployment $(date)' || true && 
            echo 'ğŸ“¥ Fetching latest changes...' &&
            git fetch origin ${{ github.ref_name }} &&
            echo 'ğŸ”„ Pulling latest code...' &&
            git pull origin ${{ github.ref_name }} && 
            echo 'âœ… Code deployed successfully'
            echo 'ğŸ“Š Current commit:' && git log --oneline -1
          "

      - name: Generate Production Environment Files
        run: |
          echo "ğŸ”§ Generating production environment files from GitHub Secrets..."
          ssh root@77.37.121.27 "
            cd '${{ env.DEPLOY_PATH }}' && 
            
            # Set environment variables for template processing
            export DB_PASSWORD='${{ secrets.DB_PASSWORD }}'
            export JWT_SECRET='${{ secrets.JWT_SECRET }}'
            export REFRESH_TOKEN_SECRET='${{ secrets.REFRESH_TOKEN_SECRET }}'
            export JWT_REFRESH_SECRET='${{ secrets.JWT_REFRESH_SECRET }}'
            export SESSION_SECRET='${{ secrets.SESSION_SECRET }}'
            export EMAIL_HOST='${{ secrets.EMAIL_HOST }}'
            export EMAIL_PORT='${{ secrets.EMAIL_PORT }}'
            export EMAIL_SECURE='${{ secrets.EMAIL_SECURE }}'
            export EMAIL_USER='${{ secrets.EMAIL_USER }}'
            export EMAIL_PASS='${{ secrets.EMAIL_PASS }}'
            export EMAIL_FROM='${{ secrets.EMAIL_FROM }}'
            export YOUTUBE_CLIENT_ID='${{ secrets.YOUTUBE_CLIENT_ID }}'
            export YOUTUBE_CLIENT_SECRET='${{ secrets.YOUTUBE_CLIENT_SECRET }}'
            export YOUTUBE_API_KEY='${{ secrets.YOUTUBE_API_KEY }}'
            export CLOUDINARY_CLOUD_NAME='${{ secrets.CLOUDINARY_CLOUD_NAME }}'
            export CLOUDINARY_API_KEY='${{ secrets.CLOUDINARY_API_KEY }}'
            export CLOUDINARY_API_SECRET='${{ secrets.CLOUDINARY_API_SECRET }}'
            export GOOGLE_CLIENT_ID='${{ secrets.GOOGLE_CLIENT_ID }}'
            export GOOGLE_CLIENT_SECRET='${{ secrets.GOOGLE_CLIENT_SECRET }}'
            export FACEBOOK_APP_ID='${{ secrets.FACEBOOK_APP_ID }}'
            export FACEBOOK_APP_SECRET='${{ secrets.FACEBOOK_APP_SECRET }}'
            export GITHUB_CLIENT_ID='${{ secrets.GITHUB_CLIENT_ID }}'
            export GITHUB_CLIENT_SECRET='${{ secrets.GITHUB_CLIENT_SECRET }}'
            export LINKEDIN_CLIENT_ID='${{ secrets.LINKEDIN_CLIENT_ID }}'
            export LINKEDIN_CLIENT_SECRET='${{ secrets.LINKEDIN_CLIENT_SECRET }}'
            export GOOGLE_API_KEY='${{ secrets.GOOGLE_API_KEY }}'
            export SENTRY_DSN='${{ secrets.SENTRY_DSN }}'
            
            # Generate environment files using the script
            echo 'ğŸ¯ Running environment generation script...'
            if [ -f './scripts/generate-env.sh' ]; then
              chmod +x ./scripts/generate-env.sh
              ./scripts/generate-env.sh
            else
              echo 'âš ï¸ Generate-env script not found, creating environment files manually...'
              
              # Create backend .env file
              cat > backend/.env << BACKEND_ENV
NODE_ENV=production
PORT=5000
DB_HOST=postgres
DB_PORT=5432
DB_NAME=attendance_tracker_prod
DB_USER=postgres
DB_PASSWORD=\$DB_PASSWORD
DB_DIALECT=postgres
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0
REDIS_URL=redis://redis:6379
JWT_SECRET=\$JWT_SECRET
JWT_EXPIRES_IN=24h
REFRESH_TOKEN_SECRET=\$REFRESH_TOKEN_SECRET
REFRESH_TOKEN_EXPIRES_IN=7d
JWT_REFRESH_SECRET=\$JWT_REFRESH_SECRET
JWT_REFRESH_EXPIRES_IN=30d
JWT_COOKIE_EXPIRES_IN=7
EMAIL_HOST=\$EMAIL_HOST
EMAIL_PORT=\$EMAIL_PORT
EMAIL_SECURE=\$EMAIL_SECURE
EMAIL_USER=\$EMAIL_USER
EMAIL_PASS=\$EMAIL_PASS
EMAIL_FROM=\$EMAIL_FROM
COMPANY_NAME=Change Ambassadors
COMPANY_ADDRESS=Kampala, Uganda
SUPPORT_EMAIL=support@changeambassadors.com
YOUTUBE_CLIENT_ID=\$YOUTUBE_CLIENT_ID
YOUTUBE_CLIENT_SECRET=\$YOUTUBE_CLIENT_SECRET
YOUTUBE_API_KEY=\$YOUTUBE_API_KEY
YOUTUBE_REDIRECT_URI=https://syncli.cloud/api/v1/auth/youtube/callback
MAX_VIDEO_SIZE=134217728
MAX_FILE_SIZE=10485760
TEMP_UPLOAD_DIR=/tmp/video-uploads
UPLOAD_DIR=./uploads
CLOUDINARY_CLOUD_NAME=\$CLOUDINARY_CLOUD_NAME
CLOUDINARY_API_KEY=\$CLOUDINARY_API_KEY
CLOUDINARY_API_SECRET=\$CLOUDINARY_API_SECRET
FRONTEND_URL=https://syncli.cloud
GOOGLE_CLIENT_ID=\$GOOGLE_CLIENT_ID
GOOGLE_CLIENT_SECRET=\$GOOGLE_CLIENT_SECRET
GOOGLE_REDIRECT_URI=https://syncli.cloud/register
FACEBOOK_APP_ID=\$FACEBOOK_APP_ID
FACEBOOK_APP_SECRET=\$FACEBOOK_APP_SECRET
FACEBOOK_REDIRECT_URI=https://syncli.cloud/register
GITHUB_CLIENT_ID=\$GITHUB_CLIENT_ID
GITHUB_CLIENT_SECRET=\$GITHUB_CLIENT_SECRET
GITHUB_REDIRECT_URI=https://syncli.cloud/register
LINKEDIN_CLIENT_ID=\$LINKEDIN_CLIENT_ID
LINKEDIN_CLIENT_SECRET=\$LINKEDIN_CLIENT_SECRET
LINKEDIN_REDIRECT_URI=https://syncli.cloud/register
SESSION_SECRET=\$SESSION_SECRET
GOOGLE_API_KEY=\$GOOGLE_API_KEY
SENTRY_DSN=\$SENTRY_DSN
BACKEND_ENV

              # Create frontend .env file
              cat > frontend/.env << FRONTEND_ENV
NODE_ENV=production
VITE_API_BASE_URL=/api/v1
VITE_API_HOST=syncli.cloud
VITE_API_PORT=443
VITE_API_PROTOCOL=https:
VITE_SOCKET_PATH=/socket.io
VITE_SOCKET_HOST=syncli.cloud
VITE_SOCKET_PORT=443
VITE_SOCKET_PROTOCOL=https:
VITE_APP_NAME=Attendance Tracker
VITE_APP_VERSION=1.0.0
VITE_ENABLE_SOCKET_IO=true
VITE_ENABLE_NOTIFICATIONS=true
VITE_SESSION_TIMEOUT=3600000
VITE_USE_PROXY=false
VITE_THEME_COLOR_PRIMARY=#fddc9a
VITE_THEME_COLOR_SECONDARY=#000000
VITE_THEME_COLOR_SUCCESS=#4caf50
VITE_THEME_COLOR_ERROR=#f44336
VITE_THEME_COLOR_WARNING=#ff9800
VITE_THEME_COLOR_INFO=#2196f3
VITE_THEME_BG_DEFAULT=#f5f5f5
VITE_THEME_BG_PAPER=#ffffff
VITE_THEME_TEXT_PRIMARY=#000000
VITE_THEME_TEXT_SECONDARY=#757575
VITE_GOOGLE_REDIRECT_URI=https://syncli.cloud/register
VITE_FACEBOOK_REDIRECT_URI=https://syncli.cloud/register
VITE_GITHUB_REDIRECT_URI=https://syncli.cloud/register
VITE_LINKEDIN_REDIRECT_URI=https://syncli.cloud/register
FRONTEND_ENV
            fi
            
            # Set secure permissions
            chmod 600 backend/.env frontend/.env 2>/dev/null || true
            
            echo 'âœ… Environment files generated successfully'
            echo 'ğŸ“„ Environment files summary:'
            ls -la backend/.env frontend/.env 2>/dev/null || echo 'Environment files created'
          "

      - name: Build and Deploy Backend
        if: github.event.inputs.deployment_type == 'full' || github.event.inputs.deployment_type == 'backend_only' || github.event_name == 'push'
        run: |
          echo "ğŸš€ Building and deploying backend..."
          ssh root@77.37.121.27 "
            cd '${{ env.DEPLOY_PATH }}' && 
            echo 'ğŸ“¦ Building backend Docker image...' && 
            docker-compose -f docker-compose.prod.yml build backend && 
            echo 'ğŸ”„ Stopping backend service...' && 
            docker-compose -f docker-compose.prod.yml stop backend 2>/dev/null || echo 'Backend was not running' &&
            echo 'âœ… Backend built successfully'
          "

      - name: Run Database Migrations
        if: github.event.inputs.deployment_type == 'full' || github.event.inputs.deployment_type == 'migrations_only' || github.event.inputs.deployment_type == 'backend_only' || github.event_name == 'push'
        run: |
          echo "ğŸ“œ Running database migrations..."
          ssh root@77.37.121.27 "
            cd '${{ env.DEPLOY_PATH }}' && 
            echo 'ğŸ” Checking for migrations...' && 
            
            # Start database services first
            echo 'ğŸ—„ï¸ Starting database services...' &&
            docker-compose -f docker-compose.prod.yml up -d postgres redis 2>/dev/null || echo 'Database services already running' &&
            sleep 10 &&
            
            if [ -d 'backend/migrations' ] && [ \"\$(ls -A backend/migrations 2>/dev/null)\" ]; then
              echo 'ğŸ“‹ Running Sequelize migrations...' && 
              docker-compose -f docker-compose.prod.yml run --rm backend npm run migrate || 
              docker-compose -f docker-compose.prod.yml run --rm backend npx sequelize-cli db:migrate || 
              echo 'âš ï¸ Sequelize migration failed or not found'
            elif [ -d 'backend/prisma' ] && [ -f 'backend/prisma/schema.prisma' ]; then
              echo 'ğŸ“‹ Running Prisma migrations...' &&
              docker-compose -f docker-compose.prod.yml run --rm backend npx prisma migrate deploy || 
              echo 'âš ï¸ Prisma migration failed'
            elif [ -d 'backend/database/migrations' ] && [ \"\$(ls -A backend/database/migrations 2>/dev/null)\" ]; then
              echo 'ğŸ“‹ Running database migrations from database/migrations...' &&
              docker-compose -f docker-compose.prod.yml run --rm backend npm run db:migrate || 
              echo 'âš ï¸ Database migration failed'
            else
              echo 'ğŸ“ No migrations found, skipping...'
            fi && 
            echo 'âœ… Migrations completed'
          "

      - name: Start Backend Service
        if: github.event.inputs.deployment_type == 'full' || github.event.inputs.deployment_type == 'backend_only' || github.event_name == 'push'
        run: |
          echo "ğŸ”„ Starting backend service..."
          ssh root@77.37.121.27 "
            cd '${{ env.DEPLOY_PATH }}' && 
            docker-compose -f docker-compose.prod.yml up -d backend && 
            echo 'âœ… Backend service started'
          "

      - name: Build and Deploy Frontend
        if: github.event.inputs.deployment_type == 'full' || github.event.inputs.deployment_type == 'frontend_only' || github.event_name == 'push'
        run: |
          echo "ğŸ¨ Building and deploying frontend..."
          ssh root@77.37.121.27 "
            cd '${{ env.DEPLOY_PATH }}' && 
            echo 'ğŸ“¦ Building frontend Docker image...' && 
            docker-compose -f docker-compose.prod.yml build frontend && 
            echo 'ğŸ”„ Stopping frontend service...' && 
            docker-compose -f docker-compose.prod.yml stop frontend 2>/dev/null || echo 'Frontend was not running' &&
            echo 'ğŸ”„ Starting frontend service...' && 
            docker-compose -f docker-compose.prod.yml up -d frontend && 
            echo 'âœ… Frontend deployed successfully'
          "

      - name: Cleanup Docker Resources
        run: |
          echo "ğŸ§¹ Cleaning up Docker resources..."
          ssh root@77.37.121.27 "
            cd '${{ env.DEPLOY_PATH }}' &&
            docker system prune -f && 
            docker image prune -f && 
            echo 'âœ… Docker cleanup completed'
          "

      - name: Health Check
        run: |
          echo "ğŸ” Running health checks..."
          ssh root@77.37.121.27 "
            cd '${{ env.DEPLOY_PATH }}' && 
            echo '=== Docker Services Status ===' && 
            docker-compose -f docker-compose.prod.yml ps && 
            echo '' && 
            echo '=== Backend Health Check ===' && 
            sleep 20 && 
            curl -f http://localhost:5000/health || curl -f http://localhost:5000/api/health || curl -f http://localhost:5000/ || echo 'âš ï¸ Backend health check failed' && 
            echo '' && 
            echo '=== Frontend Health Check ===' && 
            curl -f http://localhost:5173/ || curl -f http://localhost:80/ || echo 'âš ï¸ Frontend health check failed' && 
            echo 'âœ… Health checks completed'
          "

      - name: Verify Deployment
        run: |
          echo "ğŸ” Verifying deployment..."
          ssh root@77.37.121.27 "
            cd '${{ env.DEPLOY_PATH }}' && 
            echo '=== Repository Information ===' &&
            echo 'Repository: ${{ env.REPO_URL }}' &&
            echo 'Branch: ${{ github.ref_name }}' &&
            echo 'Commit: ${{ github.sha }}' &&
            echo '' &&
            echo '=== Git Status ===' && 
            git log --oneline -1 && 
            git remote -v &&
            echo '' && 
            echo '=== Environment Files ===' &&
            echo 'Backend .env:' && ls -la backend/.env 2>/dev/null || echo 'Backend .env not found' &&
            echo 'Frontend .env:' && ls -la frontend/.env 2>/dev/null || echo 'Frontend .env not found' &&
            echo '' && 
            echo '=== Running Containers ===' && 
            docker ps --filter 'name=attendance' --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}' && 
            echo '' && 
            echo '=== Nginx Configuration Test ===' && 
            nginx -t 2>/dev/null && echo 'âœ… Nginx config is valid' || echo 'âš ï¸ Nginx config check failed' && 
            echo '' && 
            echo '=== External Health Check ===' && 
            curl -I https://syncli.cloud/ || echo 'âš ï¸ External health check failed' && 
            echo '=== Verification completed ==='
          "

      - name: Final Status
        if: always()
        run: |
          echo "ğŸ“Š Deployment completed at $(date)"
          echo "ğŸŒ Application URL: https://syncli.cloud/"
          echo "ğŸ”§ Backend API: https://syncli.cloud/api/"
          echo "ğŸ“± Frontend: https://syncli.cloud/"
          echo "ğŸ“‹ Repository: ${{ env.REPO_URL }}"
          echo "ğŸ¯ Branch: ${{ github.ref_name }}"
          echo "ğŸ“‹ Commit: ${{ github.sha }}"
          echo ""
          echo "ğŸ”’ Environment files generated from GitHub Secrets"
          echo ""
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed! Check the logs above."
          fi
