name: Simplified Production Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deployment_type:
        description: 'Select deployment type'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - frontend_only
          - backend_only

env:
  DEPLOY_PATH: /var/www/html/Attendance_tracker

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add SSH known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 77.37.121.27 >> ~/.ssh/known_hosts

      - name: Deploy Code and Services
        run: |
          echo "ğŸš€ Starting deployment to production..."
          ssh root@77.37.121.27 << 'ENDSSH'
            set -e
            cd ${{ env.DEPLOY_PATH }}
            
            echo "ğŸ“¥ Pulling latest code..."
            git stash push -m 'Auto-stash before deployment' || true
            git fetch origin main
            git pull origin main
            
            echo "âœ… Code updated successfully"
            
            echo "ğŸ³ Starting Docker services..."
            
            # Handle deployment type
            DEPLOY_TYPE="${{ github.event.inputs.deployment_type || 'full' }}"
            
            case $DEPLOY_TYPE in
              "backend_only")
                echo "ğŸ“¦ Building and deploying backend only..."
                docker-compose -f docker-compose.prod.yml build backend
                docker-compose -f docker-compose.prod.yml up -d backend
                ;;
              "frontend_only")
                echo "ğŸ“¦ Building and deploying frontend only..."
                docker-compose -f docker-compose.prod.yml build frontend
                docker-compose -f docker-compose.prod.yml up -d frontend
                ;;
              *)
                echo "ğŸ“¦ Building and deploying all services..."
                docker-compose -f docker-compose.prod.yml build
                docker-compose -f docker-compose.prod.yml up -d
                ;;
            esac
            
            echo "â³ Waiting for services to be healthy..."
            sleep 10
            
            echo "ğŸ” Checking service status..."
            docker-compose -f docker-compose.prod.yml ps
            
            echo "âœ… Deployment completed successfully!"
          ENDSSH

      - name: Health Check
        run: |
          echo "ğŸ¥ Running health checks..."
          ssh root@77.37.121.27 << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}
            
            echo "ğŸ” Docker container status:"
            docker-compose -f docker-compose.prod.yml ps
            
            echo ""
            echo "ğŸ“Š Service health checks:"
            
            # Check backend
            if curl -f -s localhost:5001/api/v1/health > /dev/null; then
              echo "âœ… Backend is healthy"
            else
              echo "âŒ Backend health check failed"
              exit 1
            fi
            
            # Check frontend
            if curl -f -s http://localhost:5173 > /dev/null; then
              echo "âœ… Frontend is healthy"
            else
              echo "âŒ Frontend health check failed"
              exit 1
            fi
            
            echo ""
            echo "ğŸ“‹ Recent logs:"
            docker-compose -f docker-compose.prod.yml logs --tail=20
          ENDSSH

      - name: Notify Deployment Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed!"
          fi
