# QR Code System Documentation

## Overview
The QR code system enables contactless attendance marking through QR code scanning. It supports session-specific QR codes for facilitators and personal attendance QR codes for participants.

## Features Implemented

### ✅ Core Features
- Session QR code generation (for facilitators/admins)
- Personal attendance QR codes (for participants)
- QR code scanning for attendance marking
- Time-based QR code expiration
- Attendance window validation
- Duplicate attendance prevention

### ✅ Security Features
- Token-based validation
- QR code expiration (2 hours for session, 30 minutes for personal)
- Session status verification
- User permission checks
- Attendance window enforcement

## API Endpoints

### 1. Generate Session QR Code
**Endpoint:** `POST /api/v1/qrcode/session/:sessionId/generate`

**Permissions:** Admin, Moderator, or Session Facilitator

**Response:**
```json
{
  "status": "success",
  "data": {
    "qrCode": {
      "url": "/uploads/qrcodes/session-xxx-xxx.png",
      "dataURL": "data:image/png;base64,...",
      "expiresAt": "2025-07-05T17:23:33.765Z"
    }
  }
}
```

### 2. Get Session QR Code
**Endpoint:** `GET /api/v1/qrcode/session/:sessionId`

**Response:** Returns existing QR code if not expired

### 3. Generate Personal Attendance QR
**Endpoint:** `POST /api/v1/qrcode/attendance/:sessionId`

**Response:**
```json
{
  "status": "success",
  "data": {
    "qrCode": {
      "dataURL": "data:image/png;base64,...",
      "expiresAt": "2025-07-05T15:55:06.911Z"
    }
  }
}
```

### 4. Scan QR Code
**Endpoint:** `POST /api/v1/qrcode/scan`

**Request Body:**
```json
{
  "qrData": "{\"type\":\"session_attendance\",\"sessionId\":\"xxx\",\"sessionTitle\":\"...\",\"timestamp\":123456,\"token\":\"...\"}"
}
```

**Response:**
```json
{
  "status": "success",
  "message": "Attendance marked successfully via QR code",
  "data": {
    "attendance": {
      "id": "xxx",
      "status": "present",
      "checkInTime": "2025-07-05T15:24:37.687Z",
      "markedVia": "qr_code"
    },
    "session": {
      "id": "xxx",
      "title": "Session Title",
      "startTime": "16:24:37",
      "endTime": "17:24:37"
    }
  }
}
```

### 5. Validate Attendance Token
**Endpoint:** `POST /api/v1/qrcode/validate`

**Request Body:**
```json
{
  "token": "xxx",
  "sessionId": "xxx"
}
```

### 6. Cleanup Old QR Codes
**Endpoint:** `POST /api/v1/qrcode/cleanup`

**Permissions:** Admin only

## QR Code Types

### 1. Session QR Code
- Generated by facilitators/admins
- Contains session information
- Valid for 2 hours
- Can be displayed on screen for participants to scan

### 2. Personal Attendance QR
- Generated for individual participants
- Contains user-specific token
- Valid for 30 minutes
- Sent via email or displayed in app

## Frontend Implementation

### Display QR Code
```javascript
const SessionQRCode = ({ sessionId }) => {
  const [qrCode, setQrCode] = useState(null);
  
  const generateQR = async () => {
    const response = await fetch(`/api/v1/qrcode/session/${sessionId}/generate`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    const data = await response.json();
    setQrCode(data.data.qrCode);
  };
  
  return (
    <div>
      {qrCode && (
        <div>
          <img src={qrCode.dataURL} alt="Session QR Code" />
          <p>Expires at: {new Date(qrCode.expiresAt).toLocaleString()}</p>
        </div>
      )}
      <button onClick={generateQR}>Generate QR Code</button>
    </div>
  );
};
```

### QR Code Scanner
```javascript
const QRScanner = () => {
  const handleScan = async (data) => {
    if (data) {
      const response = await fetch('/api/v1/qrcode/scan', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ qrData: data })
      });
      
      const result = await response.json();
      if (result.status === 'success') {
        alert('Attendance marked successfully!');
      }
    }
  };
  
  return (
    <QrReader
      delay={300}
      onError={handleError}
      onScan={handleScan}
      style={{ width: '100%' }}
    />
  );
};
```

## QR Code Data Format

### Session QR Code
```json
{
  "type": "session_attendance",
  "sessionId": "uuid",
  "sessionTitle": "Session Name",
  "timestamp": 1234567890,
  "token": "random-token"
}
```

### Personal Attendance URL
```
https://app.com/attendance/mark/{sessionId}?token={token}&user={userId}
```

## Validation Rules

1. **Session Status**: Must be 'active' for scanning
2. **Attendance Window**: User can mark attendance from 15 minutes before start time until session end
3. **Duplicate Prevention**: Cannot mark attendance twice for same session
4. **QR Code Age**: Rejected if older than expiration time
5. **Token Validation**: Personal tokens are single-use

## Error Handling

Common errors:
- `400`: Invalid QR code format
- `400`: QR code has expired
- `400`: Session is not active
- `400`: Attendance window not open
- `403`: No permission to generate QR
- `404`: Session not found

## Best Practices

1. **Display Time**: Show QR codes for limited time during sessions
2. **Refresh**: Regenerate QR codes periodically for security
3. **Size**: Ensure QR codes are large enough to scan easily
4. **Contrast**: Use high contrast for better scanning
5. **Backup**: Provide manual attendance option as fallback

## Security Considerations

1. **Time Limits**: QR codes expire to prevent reuse
2. **Single Use**: Personal tokens can only be used once
3. **Session Binding**: QR codes are tied to specific sessions
4. **Permission Checks**: Only authorized users can generate codes
5. **Audit Trail**: All QR scans are logged with metadata

## Next Steps

1. Add QR code customization (logo, colors)
2. Implement bulk QR generation
3. Add QR code analytics
4. Create printable QR code badges
5. Add geolocation verification
6. Implement offline QR scanning
